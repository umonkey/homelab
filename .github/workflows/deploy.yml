# Deploys the updates to the server.
#
# (1) Builds all Docker images and pushes them to GHCR, in parallel.
# (2) Runs the update script on the remote server.
#
# NOTE: this needs a self-hosted actions runner installed on the
# server, see the docs folder for details.

name: Deploy to Droplet

on:
  push:
    branches: [ master ]

env:
  GHCR_TOKEN: ${{ secrets.GHCR_TOKEN }}

jobs:
  # Check which services actually need deployment.
  changes:
    runs-on: ubuntu-latest
    outputs:
      cron: ${{ steps.filter.outputs.cron }}
      nginx: ${{ steps.filter.outputs.nginx }}
      openvpn: ${{ steps.filter.outputs.openvpn }}
      files: ${{ steps.filter.outputs.files }}
      land: ${{ steps.filter.outputs.land }}
      museum: ${{ steps.filter.outputs.museum }}
    steps:
      - uses: actions/checkout@v4
      - uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            cron:
              - 'services/cron/**'
            nginx:
              - 'services/nginx/**'
            openvpn:
              - 'services/openvpn/**'
            files:
              - 'services/website-files/**'
            land:
              - 'services/website-land/**'
            museum:
              - 'services/website-museum/**'

  build-cron:
    name: "Build cron"
    needs: changes
    if: ${{ needs.changes.outputs.cron == 'true' }}
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: services/cron
    steps:
    - uses: actions/checkout@v4
    - name: "Build and push the image"
      run: make build push

  build-nginx:
    name: "Build nginx"
    needs: changes
    if: ${{ needs.changes.outputs.nginx == 'true' }}
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: services/nginx
    steps:
    - uses: actions/checkout@v4
    - name: "Build and push the image"
      run: make build push

  build-openvpn:
    name: "Build openvpn"
    needs: changes
    if: ${{ needs.changes.outputs.openvpn == 'true' }}
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: services/openvpn
    steps:
    - uses: actions/checkout@v4
    - name: "Build and push the image"
      run: make build push

  build-website-files:
    name: "Build website-files"
    needs: changes
    if: ${{ needs.changes.outputs.files == 'true' }}
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: services/website-files
    steps:
    - uses: actions/checkout@v4
    - name: "Build and push the image"
      run: make build push

  build-website-land:
    name: "Build website-land"
    needs: changes
    if: ${{ needs.changes.outputs.land == 'true' }}
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: services/website-land
    steps:
    - uses: actions/checkout@v4
    - name: "Build and push the image"
      run: make build push

  build-website-museum:
    name: "Build website-museum"
    needs: changes
    if: ${{ needs.changes.outputs.museum == 'true' }}
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: services/website-museum
    steps:
    - uses: actions/checkout@v4
    - name: "Build and push the image"
      run: make build push

  deploy:
    runs-on: [self-hosted, linux, x64]

    if: ${{ !failure() && !cancelled() }}

    needs:
      - build-cron
      - build-nginx
      - build-openvpn
      - build-website-files
      - build-website-land
      - build-website-museum

    steps:
      - name: Update the services
        run: |
          cd ~/repo
          ./update.sh
